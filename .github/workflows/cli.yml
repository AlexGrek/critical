name: CLI Build

on:
  push:
    branches: [main, master]
    paths:
      - "cli/**"
      - "shared/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "dist/cli/**"
      - ".github/workflows/cli.yml"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      tag: ${{ steps.bump.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: bump
        run: |
          # Get latest cli tag (format: cli/v0.1.0), default to 0.0.0
          LATEST_TAG=$(git tag -l 'cli/v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then
            CURRENT="0.0.0"
          else
            CURRENT="${LATEST_TAG#cli/v}"
          fi

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          # Check last commit message for MAJOR/MINOR keywords
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -q "MAJOR"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif echo "$COMMIT_MSG" | grep -q "MINOR"; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=cli/v$VERSION" >> "$GITHUB_OUTPUT"
          echo "Bumping $CURRENT -> $VERSION"

  build:
    needs: version
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: cr1t-linux-amd64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            artifact: cr1t-linux-arm64
            cross: true
          - target: x86_64-apple-darwin
            os: macos-latest
            artifact: cr1t-darwin-amd64
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact: cr1t-darwin-arm64
          - target: x86_64-pc-windows-gnu
            os: ubuntu-latest
            artifact: cr1t-windows-amd64
            cross: true
            ext: .exe

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.artifact }}

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --locked

      - name: Build
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release -p crit-cli --target ${{ matrix.target }}
          else
            cargo build --release -p crit-cli --target ${{ matrix.target }}
          fi

      - name: Package
        run: |
          mkdir -p staging
          cp target/${{ matrix.target }}/release/cr1t${{ matrix.ext }} staging/
          cp dist/cli/crit-cli-installer.sh staging/

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: staging/
          retention-days: 30

  release:
    needs: [version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create release archives
        run: |
          mkdir -p release
          for dir in artifacts/cr1t-*; do
            name=$(basename "$dir")
            if ls "$dir"/*.exe >/dev/null 2>&1; then
              (cd "$dir" && zip "../../release/${name}.zip" cr1t.exe)
            else
              (cd "$dir" && tar -czf "../../release/${name}.tar.gz" cr1t)
            fi
          done
          cp artifacts/cr1t-linux-amd64/crit-cli-installer.sh release/

      - name: Create tag
        run: |
          git tag ${{ needs.version.outputs.tag }}
          git push origin ${{ needs.version.outputs.tag }}

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: cr1t ${{ needs.version.outputs.version }}
          generate_release_notes: true
          files: release/*
