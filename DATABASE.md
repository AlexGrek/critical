# DATABASE.md — Critical ArangoDB Schema Reference

This document describes every collection in the Critical ArangoDB database, including field definitions, edge collections, and conventions.

**Always update this file** when making schema changes (new collections, field additions/removals, new indexes, new edge collections).

---

## Conventions

| Convention | Description |
|-----------|-------------|
| `_key` | ArangoDB document key; maps to the Rust `id` field via `#[serde(rename = "_key")]` |
| ID prefixes | `u_` users · `g_` groups · `sa_` service_accounts · `pa_` pipeline_accounts |
| `#[crit_resource]` macro | Attribute macro on Rust structs that injects standard fields (`id`, `meta`, `acl`, `deletion`, `hash_code`) and generates `{Name}Brief`, `to_brief()`, `compute_hash()`, `collection_name()`, `id_prefix()` |
| `ResourceMeta` | Embedded in every resource; carries `labels`, `annotations`, `created_at`, `created_by`, `updated_at`, `updated_by` |
| `AccessControlStore` | Per-document ACL: `list: [{permissions: u8, principals: [id]}]`, `last_mod_date: DateTime` |
| Soft-delete | `deletion: Option<DeletionInfo>` — present = deleted, absent = active. Queries always filter `doc.deletion == null` by default |
| `hash_code` | FNV-1a 64-bit hash of desired-state fields (all except `hash_code`, `deletion`, `_id`, `_rev`). 16-char hex string. Used for write-conflict detection |
| No migration system | ArangoDB is schemaless; adding `Option<T>` or `#[serde(default)]` fields is safe. Renames require manual data fixup |

---

## Collections

### `users` (vertex)

Stores registered user accounts. No per-document ACL (access controlled by super-permissions only).

Generated by `#[crit_resource(collection = "users", prefix = "u_", no_acl)]`.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | User ID, e.g. `u_alice` |
| `meta` | ResourceMeta | labels, annotations, created_at, created_by, updated_at, updated_by |
| `deletion` | DeletionInfo? | Present = soft-deleted. Absent = active |
| `hash_code` | String | FNV-1a hash of desired state |
| `password_hash` | String | bcrypt hash; stripped from all API responses |
| `personal.name` | String | Display name |
| `personal.gender` | String | |
| `personal.job_title` | String | |
| `personal.manager` | String? | Manager user ID |

Brief fields (returned in list queries): `id`, `meta`, `personal`

---

### `groups` (vertex)

Stores user/principal groups. Groups can be nested (a group can be a member of another group).

Generated by `#[crit_resource(collection = "groups", prefix = "g_")]`.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | Group ID, e.g. `g_engineering` |
| `meta` | ResourceMeta | |
| `acl` | AccessControlStore | Document-level ACL |
| `deletion` | DeletionInfo? | Present = soft-deleted |
| `hash_code` | String | |
| `name` | String | Display name |
| `description` | String? | Optional description |

Brief fields: `id`, `meta`, `name`

---

### `service_accounts` (vertex)

Non-human principals for API integrations. Equal-level principals in the membership graph.

Generated by `#[crit_resource(collection = "service_accounts", prefix = "sa_")]`.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | SA ID, e.g. `sa_github_actions` |
| `meta` | ResourceMeta | |
| `acl` | AccessControlStore | |
| `deletion` | DeletionInfo? | |
| `hash_code` | String | |
| `name` | String | Display name |
| `description` | String? | |
| `token_hash` | String | bcrypt hash of API token; never returned in API responses |

Brief fields: `id`, `meta`, `name`

---

### `pipeline_accounts` (vertex)

Non-human principals scoped to CI/CD pipelines. Equal-level principals in the membership graph.

Generated by `#[crit_resource(collection = "pipeline_accounts", prefix = "pa_")]`.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | PA ID, e.g. `pa_deploy_prod` |
| `meta` | ResourceMeta | |
| `acl` | AccessControlStore | |
| `deletion` | DeletionInfo? | |
| `hash_code` | String | |
| `name` | String | Display name |
| `description` | String? | |
| `scope` | String? | Scoped to a specific pipeline or project |
| `token_hash` | String | bcrypt hash of API token |

Brief fields: `id`, `meta`, `name`

---

### `memberships` (edge) ⟶ graph traversal

Edge collection connecting any principal (users, groups, service_accounts, pipeline_accounts) to groups.

Manually defined (no `#[crit_resource]` macro — not a standard resource).

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | `{principal_id}::{group_id}` |
| `_from` | String | `users/{user_id}`, `groups/{group_id}`, `service_accounts/{sa_id}`, or `pipeline_accounts/{pa_id}` |
| `_to` | String | `groups/{group_id}` |
| `principal` | PrincipalId | Denormalised; used in AQL filters |
| `group` | PrincipalId | Denormalised; used in AQL filters |

Used for graph traversal: `FOR v IN 1..10 OUTBOUND CONCAT("users/", @user) memberships`

When a principal is soft-deleted, the connected edges are removed and stored in `deletion.disconnected_edges` for possible restore.

---

### `permissions` (vertex)

Stores global (super) permissions. Each document key is a permission name; the document lists which principals hold it.

Manually defined (no `#[crit_resource]` macro).

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | Permission name, e.g. `adm_user_manager` |
| `principals` | Vec\<PrincipalId\> | Users/groups granted this permission |

**Seeded permissions** (granted to `u_root` on startup):

| Key | Purpose |
|-----|---------|
| `adm_user_manager` | Full CRUD on users and groups |
| `adm_config_editor` | Edit global configuration |
| `usr_create_groups` | Create new groups |

---

### `resource_history` (vertex)

Immutable snapshots of a resource's desired state at each change. Written by controller hooks on create/update. Survives resource deletion.

Manually defined (`HistoryEntry` struct in `util_models.rs`).

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | `{kind}_{resource_key}_{revision:06}`, e.g. `users_u_alice_000001` |
| `resource_kind` | String | e.g. `users` |
| `resource_key` | String | The resource `_key` |
| `revision` | u64 | Monotonically increasing per resource (1-based) |
| `snapshot` | JSON | Full desired-state document at this point in time |
| `changed_by` | PrincipalId | Who made the change |
| `changed_at` | DateTime | |

---

### `resource_events` (vertex)

Runtime events associated with resources (e.g. sign-in, deployment started). Not part of desired state. Survives resource deletion.

Manually defined (`ResourceEvent` struct in `util_models.rs`).

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | `ev_{event_type}_{timestamp_ns}` |
| `resource_kind` | String | e.g. `users` |
| `resource_key` | String | The resource `_key` |
| `event_type` | String | e.g. `sign_in`, `deployment_started` |
| `timestamp` | DateTime | |
| `actor` | PrincipalId? | Who triggered the event |
| `details` | JSON? | Optional event-specific payload |

Currently recorded events:

| Event | Kind | Trigger |
|-------|------|---------|
| `sign_in` | `users` | Successful password authentication |

---

## Soft Deletion

The `deletion` field uses the `DeletionInfo` struct:

```json
{
  "deleted_at": "2026-02-23T12:00:00Z",
  "deleted_by": "u_admin",
  "disconnected_edges": [
    {
      "collection": "memberships",
      "key": "u_alice::g_engineering",
      "from": "users/u_alice",
      "to": "groups/g_engineering"
    }
  ]
}
```

- **All `generic_list` and `generic_get` queries** filter `doc.deletion == null` by default
- **DELETE API endpoint** calls `generic_soft_delete`, which marks the document and captures edge info
- **Restore** (future): re-create edges from `disconnected_edges`, skipping any that target deleted documents

---

### `projects` (vertex)

Namespaces for all work items (tasks, pipelines, wikis, deployments, etc.). No ID prefix — plain identifiers serve as the namespace key.

Generated by `#[crit_resource(collection = "projects", prefix = "")]`.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | Project ID, no prefix — e.g. `api-v2`, `mobile-app` |
| `meta` | ResourceMeta | |
| `acl` | AccessControlStore | Document-level ACL |
| `deletion` | DeletionInfo? | Present = soft-deleted |
| `hash_code` | String | |
| `name` | String | Display name |
| `description` | String? | |
| `repositories` | Vec\<RepoLink\> | Source code repos linked to this project. Omitted when empty |
| `enabled_services` | Vec\<ProjectService\> | Feature modules enabled for this project. Controls visible UI tabs. Omitted when empty |

Brief fields: `id`, `meta`, `name`

#### `RepoLink` sub-type

| Field | Type | Notes |
|-------|------|-------|
| `url` | String | Repository URL |
| `provider` | RepoProvider | `git` (default), `github`, `gitlab`, `bitbucket`, `svn`, `mercurial`, `custom` |
| `name` | String? | Optional display name for this repo link |
| `default_branch` | String? | Primary branch (git-based providers only) |

#### `ProjectService` enum

Controls which feature tabs are shown in the UI for the project. Values are serialised as snake_case strings.

| Variant | Value | Description |
|---------|-------|-------------|
| `Integrations` | `"integrations"` | Webhooks, GitHub Apps, and third-party integrations |
| `Pipelines` | `"pipelines"` | Built-in CI/CD pipeline engine |
| `Deployments` | `"deployments"` | State-controlled deployment management |
| `Secrets` | `"secrets"` | Secret management (HashiCorp Vault alternative) |
| `Wikis` | `"wikis"` | Git-backed documentation wiki (Confluence alternative) |
| `Apps` | `"apps"` | Custom internal tools and micro-apps |
| `Tasks` | `"tasks"` | Issue tracking with kanban boards (JIRA alternative) |
| `Talks` | `"talks"` | Team discussion boards and threads |
| `Releases` | `"releases"` | Version tagging, changelogs, and release artifacts |
| `Environments` | `"environments"` | Dev/staging/prod environment configuration management |
| `Insights` | `"insights"` | Project analytics, burndown charts, and metrics |

---

## ER Diagram

```
users ──────────────────────── memberships (edge) ──────── groups
service_accounts ──────────────────────────────────────────── │
pipeline_accounts ─────────────────────────────────────────── │
                                                               │
              permissions                                      │
              (global super-perms, seeded at startup)          │
                                                               │
resource_history ─────────────────► (any resource kind)       │
resource_events ──────────────────► (any resource kind)       │

projects  (global resource, no parent namespace)
 └─ enabled_services[]  (ProjectService enum — determines UI tabs)
 └─ repositories[]      (RepoLink — linked source repos)
```

---

## Active Collections Summary

| Collection | Type | Status |
|-----------|------|--------|
| `users` | vertex | Active |
| `groups` | vertex | Active |
| `service_accounts` | vertex | Active |
| `pipeline_accounts` | vertex | Active |
| `memberships` | edge | Active |
| `permissions` | vertex | Active |
| `resource_history` | vertex | Active |
| `resource_events` | vertex | Active |
| `projects` | vertex | Active |

---

*Last updated: 2026-02-24*
