# DATABASE.md — Critical ArangoDB Schema Reference

This document describes every collection in the Critical ArangoDB database, including field definitions, edge collections, and conventions.

**Always update this file** when making schema changes (new collections, field additions/removals, new indexes, new edge collections).

---

## Conventions

| Convention | Description |
|-----------|-------------|
| `_key` | ArangoDB document key; maps to the Rust `id` field via `#[serde(rename = "_key")]` |
| ID prefixes | `u_` users · `g_` groups · `sa_` service_accounts · `pa_` pipeline_accounts |
| `#[crit_resource]` macro | Attribute macro on Rust structs that injects standard fields (`id`, `labels`, `annotations`, `state`, `acl`, `deletion`, `hash_code`) and generates `{Name}Brief`, `to_brief()`, `compute_hash()`, `collection_name()`, `id_prefix()` |
| `labels` / `annotations` | Top-level `Labels` (HashMap) on every resource — user-managed desired state (queryable key-value pairs and freeform strings) |
| `ResourceState` | Server-managed audit timestamps on every resource: `created_at`, `created_by`, `updated_at`, `updated_by` |
| `AccessControlStore` | Per-document ACL: `list: [{permissions: u8, principals: [id], scope?: string}]`, `last_mod_date: DateTime`. The optional `scope` field (on project ACL entries) restricts an entry to a specific resource kind (e.g. `"tasks"`); absent or `"*"` matches all kinds |
| Soft-delete | `deletion: Option<DeletionInfo>` — present = deleted, absent = active. Queries always filter `doc.deletion == null` by default |
| `hash_code` | FNV-1a 64-bit hash of desired-state fields (all except `hash_code`, `deletion`, `_id`, `_rev`). 16-char hex string. Used for write-conflict detection |
| No migration system | ArangoDB is schemaless; adding `Option<T>` or `#[serde(default)]` fields is safe. Renames require manual data fixup |

---

## Collections

### `users` (vertex)

Stores registered user accounts. No per-document ACL (access controlled by super-permissions only).

Generated by `#[crit_resource(collection = "users", prefix = "u_", no_acl)]`.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | User ID, e.g. `u_alice` |
| `labels` | Labels | Queryable key-value pairs (user-managed desired state) |
| `annotations` | Labels | Non-queryable freeform strings (user-managed desired state) |
| `state` | ResourceState | Server-managed audit: `created_at`, `created_by`, `updated_at`, `updated_by` |
| `deletion` | DeletionInfo? | Present = soft-deleted. Absent = active |
| `hash_code` | String | FNV-1a hash of desired state |
| `password_hash` | String | bcrypt hash; stripped from all API responses |
| `personal.name` | String | Display name |
| `personal.gender` | String | |
| `personal.job_title` | String | |
| `personal.manager` | String? | Manager user ID |
| `avatar_ulid` | String? | ULID of the active avatar upload. Absent until first upload accepted. See `user_avatars/` in object store |
| `wallpaper_ulid` | String? | ULID of the active wallpaper upload. See `user_wallpapers/` in object store |

Brief fields (returned in list queries): `id`, `labels`, `annotations`, `personal`

---

### `groups` (vertex)

Stores user/principal groups. Groups can be nested (a group can be a member of another group).

Generated by `#[crit_resource(collection = "groups", prefix = "g_")]`.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | Group ID, e.g. `g_engineering` |
| `labels` | Labels | Queryable key-value pairs |
| `annotations` | Labels | Non-queryable freeform strings |
| `state` | ResourceState | Server-managed audit timestamps |
| `acl` | AccessControlStore | Document-level ACL |
| `deletion` | DeletionInfo? | Present = soft-deleted |
| `hash_code` | String | |
| `name` | String | Display name |
| `description` | String? | Optional description |

Brief fields: `id`, `labels`, `annotations`, `name`

---

### `service_accounts` (vertex)

Non-human principals for API integrations. Equal-level principals in the membership graph.

Generated by `#[crit_resource(collection = "service_accounts", prefix = "sa_")]`.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | SA ID, e.g. `sa_github_actions` |
| `labels` | Labels | Queryable key-value pairs |
| `annotations` | Labels | Non-queryable freeform strings |
| `state` | ResourceState | Server-managed audit timestamps |
| `acl` | AccessControlStore | |
| `deletion` | DeletionInfo? | |
| `hash_code` | String | |
| `name` | String | Display name |
| `description` | String? | |
| `token_hash` | String | bcrypt hash of API token; never returned in API responses |

Brief fields: `id`, `labels`, `annotations`, `name`

---

### `pipeline_accounts` (vertex)

Non-human principals scoped to CI/CD pipelines. Equal-level principals in the membership graph.

Generated by `#[crit_resource(collection = "pipeline_accounts", prefix = "pa_")]`.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | PA ID, e.g. `pa_deploy_prod` |
| `labels` | Labels | Queryable key-value pairs |
| `annotations` | Labels | Non-queryable freeform strings |
| `state` | ResourceState | Server-managed audit timestamps |
| `acl` | AccessControlStore | |
| `deletion` | DeletionInfo? | |
| `hash_code` | String | |
| `name` | String | Display name |
| `description` | String? | |
| `scope` | String? | Scoped to a specific pipeline or project |
| `token_hash` | String | bcrypt hash of API token |

Brief fields: `id`, `labels`, `annotations`, `name`

---

### `memberships` (edge) ⟶ graph traversal

Edge collection connecting any principal (users, groups, service_accounts, pipeline_accounts) to groups.

Manually defined (no `#[crit_resource]` macro — not a standard resource).

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | `{principal_id}::{group_id}` |
| `_from` | String | `users/{user_id}`, `groups/{group_id}`, `service_accounts/{sa_id}`, or `pipeline_accounts/{pa_id}` |
| `_to` | String | `groups/{group_id}` |
| `principal` | PrincipalId | Denormalised; used in AQL filters |
| `group` | PrincipalId | Denormalised; used in AQL filters |

Used for graph traversal: `FOR v IN 1..10 OUTBOUND CONCAT("users/", @user) memberships`

When a principal is soft-deleted, the connected edges are removed and stored in `deletion.disconnected_edges` for possible restore.

---

### `permissions` (vertex)

Stores global (super) permissions. Each document key is a permission name; the document lists which principals hold it.

Manually defined (no `#[crit_resource]` macro).

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | Permission name, e.g. `adm_user_manager` |
| `principals` | Vec\<PrincipalId\> | Users/groups granted this permission |

**Seeded permissions** (granted to `u_root` on startup):

| Key | Purpose |
|-----|---------|
| `adm_user_manager` | Full CRUD on users and groups |
| `adm_config_editor` | Edit global configuration and projects |
| `usr_create_groups` | Create new groups |
| `usr_create_projects` | Create new projects |

---

### `resource_history` (vertex)

Immutable snapshots of a resource's desired state at each change. Written by controller hooks on create/update. Survives resource deletion.

Manually defined (`HistoryEntry` struct in `util_models.rs`).

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | `{kind}_{resource_key}_{revision:06}`, e.g. `users_u_alice_000001` |
| `resource_kind` | String | e.g. `users` |
| `resource_key` | String | The resource `_key` |
| `revision` | u64 | Monotonically increasing per resource (1-based) |
| `snapshot` | JSON | Full desired-state document at this point in time |
| `changed_by` | PrincipalId | Who made the change |
| `changed_at` | DateTime | |

---

### `resource_events` (vertex)

Runtime events associated with resources (e.g. sign-in, deployment started). Not part of desired state. Survives resource deletion.

Manually defined (`ResourceEvent` struct in `util_models.rs`).

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | `ev_{event_type}_{timestamp_ns}` |
| `resource_kind` | String | e.g. `users` |
| `resource_key` | String | The resource `_key` |
| `event_type` | String | e.g. `sign_in`, `deployment_started` |
| `timestamp` | DateTime | |
| `actor` | PrincipalId? | Who triggered the event |
| `details` | JSON? | Optional event-specific payload |

Currently recorded events:

| Event | Kind | Trigger |
|-------|------|---------|
| `sign_in` | `users` | Successful password authentication |

---

## Soft Deletion

The `deletion` field uses the `DeletionInfo` struct:

```json
{
  "deleted_at": "2026-02-23T12:00:00Z",
  "deleted_by": "u_admin",
  "disconnected_edges": [
    {
      "collection": "memberships",
      "key": "u_alice::g_engineering",
      "from": "users/u_alice",
      "to": "groups/g_engineering"
    }
  ]
}
```

- **All `generic_list` and `generic_get` queries** filter `doc.deletion == null` by default
- **DELETE API endpoint** calls `generic_soft_delete`, which marks the document and captures edge info
- **Restore** (future): re-create edges from `disconnected_edges`, skipping any that target deleted documents

---

### `projects` (vertex)

Namespaces for all work items (tasks, pipelines, wikis, deployments, etc.). No ID prefix — plain identifiers serve as the namespace key.

Generated by `#[crit_resource(collection = "projects", prefix = "")]`.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | Project ID, no prefix — e.g. `api-v2`, `mobile-app` |
| `labels` | Labels | Queryable key-value pairs |
| `annotations` | Labels | Non-queryable freeform strings |
| `state` | ResourceState | Server-managed audit timestamps |
| `acl` | AccessControlStore | Document-level ACL |
| `deletion` | DeletionInfo? | Present = soft-deleted |
| `hash_code` | String | |
| `name` | String | Display name |
| `description` | String? | |
| `repositories` | Vec\<RepoLink\> | Source code repos linked to this project. Omitted when empty |
| `enabled_services` | Vec\<ProjectService\> | Feature modules enabled for this project. Controls visible UI tabs. Omitted when empty |

Brief fields: `id`, `labels`, `annotations`, `name`

#### `RepoLink` sub-type

| Field | Type | Notes |
|-------|------|-------|
| `url` | String | Repository URL |
| `provider` | RepoProvider | `git` (default), `github`, `gitlab`, `bitbucket`, `svn`, `mercurial`, `custom` |
| `name` | String? | Optional display name for this repo link |
| `default_branch` | String? | Primary branch (git-based providers only) |

#### `ProjectService` enum

Controls which feature tabs are shown in the UI for the project. Values are serialised as snake_case strings.

| Variant | Value | Description |
|---------|-------|-------------|
| `Integrations` | `"integrations"` | Webhooks, GitHub Apps, and third-party integrations |
| `Pipelines` | `"pipelines"` | Built-in CI/CD pipeline engine |
| `Deployments` | `"deployments"` | State-controlled deployment management |
| `Secrets` | `"secrets"` | Secret management (HashiCorp Vault alternative) |
| `Wikis` | `"wikis"` | Git-backed documentation wiki (Confluence alternative) |
| `Apps` | `"apps"` | Custom internal tools and micro-apps |
| `Tasks` | `"tasks"` | Issue tracking with kanban boards (JIRA alternative) |
| `Talks` | `"talks"` | Team discussion boards and threads |
| `Releases` | `"releases"` | Version tagging, changelogs, and release artifacts |
| `Environments` | `"environments"` | Dev/staging/prod environment configuration management |
| `Insights` | `"insights"` | Project analytics, burndown charts, and metrics |

---

## ER Diagram

```
users ──────────────────────── memberships (edge) ──────── groups
service_accounts ──────────────────────────────────────────── │
pipeline_accounts ─────────────────────────────────────────── │
                                                               │
              permissions                                      │
              (global super-perms, seeded at startup)          │
                                                               │
resource_history ─────────────────► (any resource kind)       │
resource_events ──────────────────► (any resource kind)       │

projects  (global resource, no parent namespace)
 └─ enabled_services[]  (ProjectService enum — determines UI tabs)
 └─ repositories[]      (RepoLink — linked source repos)
 └─ acl.list[].scope    (optional — restricts entry to one resource kind)
 └─ {scoped resource}   (any collection with project field, e.g. tasks, pipelines)
```

---

## Scoped Resources

Resources belonging to a project carry a `project` field containing the project's `_key`. This is **Variant A** namespacing: all documents of the same kind share one collection (e.g. `tasks`), filtered by `project`.

### Conventions

| Convention | Detail |
|------------|--------|
| `project` field | String — the parent project `_key` (e.g. `"api-v2"`) |
| Required index | Every scoped collection must have a persistent index on `["project", "deletion"]` |
| API routes | `/v1/projects/{project}/{kind}` and `/v1/projects/{project}/{kind}/{id}` |
| ACL resolution | **Hybrid** — resource's own `acl.list` used if non-empty; otherwise falls back to the project's `acl` filtered by `scope` matching the resource kind |
| Create permission | Requires `CREATE` bit on the project's ACL (scoped to the resource kind) |

### Hybrid ACL Resolution

For a scoped resource, permission is checked as follows:

1. If `doc.acl.list` is non-empty → use the resource's own ACL (override mode)
2. Else → use the **parent project's ACL**, filtering entries where `scope` is absent, `"*"`, or equals the resource kind name (e.g. `"tasks"`)

This lets projects grant blanket access to all task contributors without each individual task needing its own ACL.

### Example: Project ACL with scoped entries

```json
{
  "acl": {
    "list": [
      { "permissions": 127, "principals": ["u_alice"] },
      { "permissions": 31,  "principals": ["g_devs"],   "scope": "tasks" },
      { "permissions": 7,   "principals": ["g_viewers"], "scope": "*" }
    ],
    "last_mod_date": "2026-02-26T10:00:00Z"
  }
}
```

- Alice has ROOT on everything in the project (no scope = wildcard)
- `g_devs` has WRITE on tasks only
- `g_viewers` has READ on all scoped resource kinds in the project

---

---

### `unprocessed_images` (vertex)

Tracks raw uploaded images that are pending background processing. Inserted when an upload is accepted; hard-deleted when background processing completes (success or failure). If this collection has stale rows, a background task likely crashed mid-way.

Manually defined (`UnprocessedImage` struct in `util_models.rs`). No `#[crit_resource]` macro — not a standard API resource.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | ULID (no extension), e.g. `01jz0a9rp700000000000000000` |
| `filename` | String | `{ulid}.{ext}`, e.g. `01jz....jpg` — path inside `raw_uploads/` |
| `owner_id` | String | User ID who triggered the upload |
| `upload_type` | String | `"avatar"` or `"wallpaper"` |
| `created_at` | DateTime | Upload acceptance timestamp |

---

### `persistent_files` (vertex)

Permanent record for fully processed, stored image files. Written by the background processing task after both WebP variants are stored in the object store.

Manually defined (`PersistentFile` struct in `util_models.rs`). No `#[crit_resource]` macro.

| Field | Type | Notes |
|-------|------|-------|
| `_key` | String | ULID matching the user's `avatar_ulid` / `wallpaper_ulid` |
| `category` | String | Object-store subdirectory: `user_avatars` or `user_wallpapers` |
| `relation_type` | String | Always `"principal"` (reserved for future relation types) |
| `owner` | String | User ID who owns this file |
| `format` | String | Always `"webp"` |
| `sizes` | Vec\<String\> | `["hd", "thumb"]` |
| `total_size_bytes` | u64 | Combined byte size of both variants |
| `filenames` | Vec\<String\> | Full object-store paths, e.g. `["user_avatars/01jz..._hd.webp", "user_avatars/01jz..._thumb.webp"]` |
| `uri.hd` | String | HD filename only, e.g. `01jz..._hd.webp` |
| `uri.thumb` | String | Thumbnail filename only, e.g. `01jz..._thumb.webp` |
| `created_at` | DateTime | Processing completion timestamp |

#### Object-store layout

```
raw_uploads/                   ← raw bytes, ephemeral (deleted after processing)
  {ulid}.{ext}

user_avatars/                  ← processed avatar WebP files
  {ulid}_hd.webp               ← 480 × 480 px
  {ulid}_thumb.webp            ← 128 × 128 px

user_wallpapers/               ← processed wallpaper WebP files
  {ulid}_hd.webp               ← 1400 × 600 px
  {ulid}_thumb.webp            ← 300 × 128 px
```

---

## Active Collections Summary

| Collection | Type | Status |
|-----------|------|--------|
| `users` | vertex | Active |
| `groups` | vertex | Active |
| `service_accounts` | vertex | Active |
| `pipeline_accounts` | vertex | Active |
| `memberships` | edge | Active |
| `permissions` | vertex | Active |
| `resource_history` | vertex | Active |
| `resource_events` | vertex | Active |
| `projects` | vertex | Active |
| `unprocessed_images` | vertex | Active |
| `persistent_files` | vertex | Active |

---

*Last updated: 2026-02-28*
